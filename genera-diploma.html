<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genera Diploma - Accademia Online Globale</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .preview-container {
            margin-top: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .diploma-preview {
            background: #fff;
            padding: 40px;
            border: 10px solid #0056b3;
            text-align: center;
            position: relative;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .diploma-preview h2 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #0056b3;
        }
        
        .diploma-preview .seal {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 100px;
            height: 100px;
            background: #0056b3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .barcode {
            margin-top: 20px;
            padding: 10px;
            background: #f0f0f0;
            display: inline-block;
        }
        
        /* Adding error state styling */
        .form-group input.error, .form-group select.error {
            border-color: #ff3860;
        }
    </style>
</head>
<body>
    <!-- Header section removed as requested -->

    <section class="page-header">
        <div class="container">
            <h2>Genera Diploma di Scuola Superiore</h2>
            <p>Compila il modulo per generare il tuo diploma personalizzato</p>
        </div>
    </section>

    <section class="diploma-generator">
        <!-- Removing the container div as requested -->
        <div id="exam-verification-container">
            <!-- This will be populated by JavaScript based on exam status -->
        </div>
        
        <div class="form-container" id="diploma-form-container" style="display: none;">
            <form id="diploma-form">
                <div class="form-row">
                    <div class="form-group">
                            <label for="nome">Nome</label>
                            <input type="text" id="nome" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label for="cognome">Cognome</label>
                            <input type="text" id="cognome" name="cognome" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="indirizzo">Indirizzo di Studio</label>
                        <select id="indirizzo" name="indirizzo" required>
                            <option value="">Seleziona un indirizzo</option>
                            <option value="Liceo Scientifico">Liceo Scientifico</option>
                            <option value="Liceo Classico">Liceo Classico</option>
                            <option value="Liceo Linguistico">Liceo Linguistico</option>
                            <option value="Liceo Artistico">Liceo Artistico</option>
                            <option value="Liceo delle Scienze Umane">Liceo delle Scienze Umane</option>
                            <option value="Liceo Musicale e Coreutico">Liceo Musicale e Coreutico</option>
                            <option value="Istituto Tecnico Economico">Istituto Tecnico Economico</option>
                            <option value="Istituto Tecnico Tecnologico">Istituto Tecnico Tecnologico</option>
                            <option value="Istituto Tecnico Agrario">Istituto Tecnico Agrario</option>
                            <option value="Istituto Tecnico per il Turismo">Istituto Tecnico per il Turismo</option>
                            <option value="Istituto Professionale">Istituto Professionale</option>
                            <option value="Istituto Professionale per i Servizi">Istituto Professionale per i Servizi</option>
                            <option value="Istituto Professionale per l'Industria e l'Artigianato">Istituto Professionale per l'Industria e l'Artigianato</option>
                            <option value="Istituto Professionale per l'Agricoltura">Istituto Professionale per l'Agricoltura</option>
                            <option value="Studi Generali">Studi Generali</option>
                            <option value="Scienza e Tecnologia">Scienza e Tecnologia</option>
                            <option value="Business ed Economia">Business ed Economia</option>
                            <option value="Arte e Discipline Umanistiche">Arte e Discipline Umanistiche</option>
                        </select>
                    </div>
                    
                    <!-- Rimuovere il secondo menu a tendina duplicato -->
                    <div class="form-group">
                        <label for="indirizzo">Indirizzo di Studio</label>
                        <select id="indirizzo" name="indirizzo" required>
                            <option value="">Seleziona un indirizzo</option>
                            <option value="Liceo Scientifico">Liceo Scientifico</option>
                            <option value="Liceo Classico">Liceo Classico</option>
                            <option value="Liceo Linguistico">Liceo Linguistico</option>
                            <option value="Liceo Artistico">Liceo Artistico</option>
                            <option value="Liceo delle Scienze Umane">Liceo delle Scienze Umane</option>
                            <option value="Liceo Musicale e Coreutico">Liceo Musicale e Coreutico</option>
                            <option value="Istituto Tecnico Economico">Istituto Tecnico Economico</option>
                            <option value="Istituto Tecnico Tecnologico">Istituto Tecnico Tecnologico</option>
                            <option value="Istituto Tecnico Agrario">Istituto Tecnico Agrario</option>
                            <option value="Istituto Tecnico per il Turismo">Istituto Tecnico per il Turismo</option>
                            <option value="Istituto Professionale">Istituto Professionale</option>
                            <option value="Istituto Professionale per i Servizi">Istituto Professionale per i Servizi</option>
                            <option value="Istituto Professionale per l'Industria e l'Artigianato">Istituto Professionale per l'Industria e l'Artigianato</option>
                            <option value="Istituto Professionale per l'Agricoltura">Istituto Professionale per l'Agricoltura</option>
                            <option value="Studi Generali">Studi Generali</option>
                            <option value="Scienza e Tecnologia">Scienza e Tecnologia</option>
                            <option value="Business ed Economia">Business ed Economia</option>
                            <option value="Arte e Discipline Umanistiche">Arte e Discipline Umanistiche</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data-nascita">Data di Nascita</label>
                            <input type="date" id="data-nascita" name="data-nascita" required>
                        </div>
                        <div class="form-group">
                            <label for="luogo-nascita">Luogo di Nascita</label>
                            <input type="text" id="luogo-nascita" name="luogo-nascita" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="data-diploma">Data di Conseguimento</label>
                            <input type="date" id="data-diploma" name="data-diploma" required>
                        </div>
                        <div class="form-group">
                            <label for="voto">Voto Finale</label>
                            <input type="text" id="voto" name="voto" placeholder="es. 100/100" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn">Genera Diploma</button>
                    </div>
                </form>
                
                <!-- Aggiungiamo la sezione di anteprima mancante -->
                <div id="preview-section" style="display: none;">
                    <h3>Anteprima del Diploma</h3>
                    <div class="preview-container">
                        <div class="diploma-preview">
                            <h2>Accademia Online Globale</h2>
                            <h3>Diploma di Scuola Superiore</h3>
                            <p>Si certifica che</p>
                            <h3 id="preview-nome"></h3>
                            <p>Nato/a il <span id="preview-data-nascita"></span> a <span id="preview-luogo-nascita"></span></p>
                            <p>Ha completato con successo il corso di studi in</p>
                            <h4 id="preview-indirizzo"></h4>
                            <p>Con votazione finale di <span id="preview-voto"></span></p>
                            <p>In data <span id="preview-data-diploma"></span></p>
                            <div class="seal">AOG</div>
                            <div class="barcode">
                                <p>Codice di verifica: <span id="preview-codice"></span></p>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button id="download-btn" class="btn">Scarica Diploma</button>
                        <button id="print-btn" class="btn">Stampa Diploma</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user has passed the exam
            const examStatus = localStorage.getItem('examStatus');
            const examPath = localStorage.getItem('examPath');
            const examDate = localStorage.getItem('examDate');
            const verificationContainer = document.getElementById('exam-verification-container');
            const formContainer = document.getElementById('diploma-form-container');
            
            // Format date function
            function formatDate(dateString) {
                if (!dateString) return 'Data non disponibile';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('it-IT', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return 'Data non valida';
                }
            }
            
            // Determine current page type
            const currentPage = window.location.pathname.split('/').pop();
            let requiredExamPath = '';
            let certificateType = '';
            
            if (currentPage.includes('genera-diploma')) {
                requiredExamPath = 'diploma';
                certificateType = 'diploma di scuola superiore';
            } else if (currentPage.includes('genera-laurea-triennale')) {
                requiredExamPath = 'triennale';
                certificateType = 'laurea triennale';
            } else if (currentPage.includes('genera-laurea-magistrale')) {
                requiredExamPath = 'magistrale';
                certificateType = 'laurea magistrale';
            }
            
            // Check exam status and show appropriate message
            if (examStatus === 'passed' && examPath === requiredExamPath) {
                // User has passed the correct exam
                verificationContainer.innerHTML = `
                    <div style="background-color: #d4edda; border-left: 4px solid #28a745; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="color: #155724; margin-top: 0;"><i class="fas fa-check-circle"></i> Esame Superato</h3>
                        <p>Hai superato l'esame di valutazione per ${certificateType} in data ${formatDate(examDate)}.</p>
                        <p>Ora puoi procedere con la generazione del tuo certificato.</p>
                    </div>
                `;
                formContainer.style.display = 'block';
            } else if (examStatus === 'passed' && examPath !== requiredExamPath) {
                // User has passed a different exam
                verificationContainer.innerHTML = `
                    <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="color: #856404; margin-top: 0;"><i class="fas fa-exclamation-triangle"></i> Esame Non Corrispondente</h3>
                        <p>Hai superato un esame diverso (${examPath}) in data ${formatDate(examDate)}.</p>
                        <p>Per generare un ${certificateType}, devi superare l'esame specifico per questo tipo di certificato.</p>
                        <a href="esame.html?type=${requiredExamPath}" class="btn" style="margin-top: 10px;">Vai all'Esame</a>
                    </div>
                `;
            } else if (examStatus === 'failed') {
                // User has failed the exam
                verificationContainer.innerHTML = `
                    <div style="background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="color: #721c24; margin-top: 0;"><i class="fas fa-times-circle"></i> Esame Non Superato</h3>
                        <p>Non hai superato l'esame di valutazione in data ${formatDate(examDate)}.</p>
                        <p>Per generare un ${certificateType}, devi prima superare l'esame di valutazione.</p>
                        <a href="esame.html?type=${requiredExamPath}" class="btn" style="margin-top: 10px;">Riprova l'Esame</a>
                    </div>
                `;
            } else {
                // User has not taken the exam
                verificationContainer.innerHTML = `
                    <div style="background-color: #f8f9fa; border-left: 4px solid #6c757d; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="color: #6c757d; margin-top: 0;"><i class="fas fa-info-circle"></i> Esame Non Sostenuto</h3>
                        <p>Non hai ancora sostenuto l'esame di valutazione per ${certificateType}.</p>
                        <p>Per generare un certificato, devi prima superare l'esame di valutazione.</p>
                        <a href="esame.html?type=${requiredExamPath}" class="btn" style="margin-top: 10px;">Vai all'Esame</a>
                    </div>
                `;
            }
            
            // Existing form event listeners and functionality
            const diplomaForm = document.getElementById('diploma-form');
            const previewSection = document.getElementById('preview-section');
            const downloadBtn = document.getElementById('download-btn');
            const printBtn = document.getElementById('print-btn');
            
            // Add validation visual feedback
            diplomaForm.querySelectorAll('input[required], select[required]').forEach(field => {
                field.addEventListener('invalid', function() {
                    this.classList.add('error');
                });
                
                field.addEventListener('input', function() {
                    this.classList.remove('error');
                });
            });
            
            diplomaForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form values
                const nome = document.getElementById('nome').value;
                const cognome = document.getElementById('cognome').value;
                const indirizzo = document.getElementById('indirizzo').value;
                const dataNascita = new Date(document.getElementById('data-nascita').value);
                const luogoNascita = document.getElementById('luogo-nascita').value;
                const dataDiploma = new Date(document.getElementById('data-diploma').value);
                const voto = document.getElementById('voto').value;
                
                // Format dates with error handling
                let formattedDataNascita, formattedDataDiploma;
                
                try {
                    formattedDataNascita = dataNascita.toLocaleDateString('it-IT');
                    if (formattedDataNascita === 'Invalid Date') throw new Error('Invalid date');
                } catch (error) {
                    formattedDataNascita = 'Data non valida';
                }
                
                try {
                    formattedDataDiploma = dataDiploma.toLocaleDateString('it-IT');
                    if (formattedDataDiploma === 'Invalid Date') throw new Error('Invalid date');
                } catch (error) {
                    formattedDataDiploma = 'Data non valida';
                }
                
                // Generate verification code
                const verificationCode = generateVerificationCode(nome, cognome, dataNascita);
                
                // Update preview
                document.getElementById('preview-nome').textContent = nome + ' ' + cognome;
                document.getElementById('preview-data-nascita').textContent = formattedDataNascita;
                document.getElementById('preview-luogo-nascita').textContent = luogoNascita;
                document.getElementById('preview-indirizzo').textContent = indirizzo;
                document.getElementById('preview-voto').textContent = voto;
                document.getElementById('preview-data-diploma').textContent = formattedDataDiploma;
                document.getElementById('preview-codice').textContent = verificationCode;
                
                // Show preview section
                previewSection.style.display = 'block';
                
                // Scroll to preview
                previewSection.scrollIntoView({ behavior: 'smooth' });
            });
            
            // Function to generate a verification code with error handling
            function generateVerificationCode(nome, cognome, dataNascita) {
                const timestamp = new Date().getTime();
                const randomNum = Math.floor(Math.random() * 10000);
                const nameInitials = nome.charAt(0) + cognome.charAt(0);
                // Handle invalid date
                const birthYear = isNaN(dataNascita.getFullYear()) ? new Date().getFullYear() : dataNascita.getFullYear();
                
                return `AOG-${nameInitials}${birthYear}-${randomNum}-${timestamp.toString().slice(-6)}`;
            }
            
            // Download functionality - modificata per salvare come JPG
            downloadBtn.addEventListener('click', function() {
                try {
                    // Imposta il certificato come generato nel localStorage
                    localStorage.setItem('certificateGenerated', 'true');
                    localStorage.setItem('certificateType', 'diploma');
                    
                    // Ottieni il contenuto del diploma
                    const diplomaElement = document.querySelector('.diploma-preview');
                    
                    if (!diplomaElement) {
                        console.error("Elemento diploma-preview non trovato");
                        alert("Errore: impossibile trovare l'anteprima del diploma");
                        return;
                    }
                    
                    // Usa html2canvas per convertire l'elemento HTML in un'immagine
                    html2canvas(diplomaElement, {
                        scale: 2, // Migliora la qualità dell'immagine
                        useCORS: true, // Permette di caricare immagini da altri domini
                        logging: false,
                        backgroundColor: "#ffffff"
                    }).then(canvas => {
                        // Converti il canvas in un'immagine JPG
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);
                        
                        // Crea un link per il download
                        const a = document.createElement('a');
                        a.href = imgData;
                        a.download = 'diploma_' + document.getElementById('nome').value + '_' + document.getElementById('cognome').value + '.jpg';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        // Mostra notifica
                        alert('Diploma scaricato come immagine JPG!');
                    }).catch(error => {
                        console.error("Errore nella conversione in immagine:", error);
                        alert("Errore durante la creazione dell'immagine. Riprova.");
                    });
                } catch (error) {
                    console.error("Errore durante il download:", error);
                    alert("Errore durante il download. Riprova.");
                }
            });
            
            // Print functionality remains unchanged
        });
    </script>
</body>
</html>